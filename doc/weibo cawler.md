# 微博爬虫

## 前言

由于新浪微博API的封锁，使得普通开发者无法通过官方的API进行搜索等高级数据操作。故自己自己实现一个基于网页版微博获取微博数据的爬虫。

通过该爬虫，可以非常简单地使用微博的所有功能，而不会受限于微博的API。

## 实现

### 登陆

### 搜索

虽然网页版微博可以实现搜索，但是可以得到的数据量也是十分有限的。

- 通过桌面版进行搜索可以得到大约20*50条数据，排序无法控制。    
- 通过移动版进行搜索可以获得大约10*100条数据，排序同样无法控制。  

但是使用移动版数据量更小，对网络带宽要求更低，而且暂时没有使用验证码进行验证。

#### 获取搜索页面

移动版的搜索链接为[http://m.weibo.cn/searchs/result](http://m.weibo.cn/searchs/result '点击访问')

参数有2个：

- type，搜索的类型，可选为微博（wb），所有（all），用户（user）
- queryVal，搜索的关键字

参数使用**GET**方法传递。

发送构造的请求，微博服务器会返回重定向的相应头，并追加一些参数到url中，访问重定向的链接，可以得到搜索返回第一页的内容。

#### 搜索结果的分析

第一页的使用HTML进行传递（后面的都是Ajax），虽然结果在HTML中，但实质是在script标签中以Json的的形式进行存储。为了提高解析速度和通用性，仅提取其中可以决定唯一一条微博的<uid, mid>序列。

使用如下正则表达式可以直接搜索出所有的<uid, mid>序列。（还需要进行长时间的使用验证和修改）

```
"mid":"(\d{16})"[\s\S]+?"\\/u\\/(\d+?)"
```

#### 分析结果的分发

虽然搜索只能获取到1000+条数据，但是需要进行100次请求，而且为了避免账号被BAN，需要限制请求速度，这样等100次请求下来再返回数据处理，势必会影响效率。

```
search(key, type)
	|-search_page_handler(html)
		|-get_weibo(<uid, mid>)
```

在此处，搜索函数会使用回调来返回搜索的结果，默认的回调调用如下：  
search函数使用关键字进行搜索，得到html字符串，调用search_page_handler进行解析，解析完毕后得到<uid, mid>序列，再调用get_weibo获取微博的完整内容。  

内容还包括搜索结果的最大页数（最大只会是100）和访问链接（需要进行简单拼凑）。  


### 获取微博信息

### 获取用户信息


